from sqlmodel import Session, create_engine
from datetime import datetime
from models import Клиент, Отделение, Сотрудник, Отправление, ИсторияСтатусов, Маршрут, Оплата, Заявка
import os

# Подключение к БД через DATABASE_URL
DATABASE_URL = os.getenv("DATABASE_URL", "postgresql+psycopg2://postgres:1234@localhost:5432/postoffice")
engine = create_engine(DATABASE_URL, echo=True)

def create_and_populate():
    # Создаем таблицы
    from sqlmodel import SQLModel
    SQLModel.metadata.create_all(engine)

    with Session(engine) as session:
        # Добавляем клиентов
        клиент1 = Клиент(имя="Алиса", фамилия="Иванова", телефон="+79100000001", электронная_почта="alice@example.com", адрес="ул. Пушкина, 1")
        клиент2 = Клиент(имя="Боб", фамилия="Петров", телефон="+79100000002", электронная_почта="bob@example.com", адрес="ул. Ленина, 2")
        session.add_all([клиент1, клиент2])
        session.commit()

        # Добавляем отделения
        отделение1 = Отделение(код="BR-001", адрес="г. Москва, ул. Ц., 5", телефон="+74951230001")
        отделение2 = Отделение(код="BR-002", адрес="г. СПб, ул. Н., 12", телефон="+78123004567")
        session.add_all([отделение1, отделение2])
        session.commit()

        # Добавляем сотрудников
        сотрудник1 = Сотрудник(имя="Ольга", фамилия="Смирнова", роль="оператор", отделение_id=1)
        сотрудник2 = Сотрудник(имя="Иван", фамилия="Кузнецов", роль="курьер", отделение_id=1)
        session.add_all([сотрудник1, сотрудник2])
        session.commit()

        # Добавляем отправление
        отправление1 = Отправление(
            id="TRK0001",
            тип="посылка",
            вес=2.5,
            отправитель_id=1,
            получатель_id=2,
            адрес_отправителя="ул. Пушкина, 1",
            адрес_получателя="ул. Ленина, 2",
            текущий_статус="Зарегистрировано"
        )
        session.add(отправление1)
        session.commit()

        # Добавляем платеж
        оплата1 = Оплата(
            отправление_id="TRK0001",
            клиент_id=1,
            сумма=250.0,
            способ="карта",
            время=datetime.now()
        )
        session.add(оплата1)
        session.commit()

        # Добавляем историю статусов
        история1 = ИсторияСтатусов(
            отправление_id="TRK0001",
            время=datetime.now(),
            статус="Зарегистрировано",
            отделение_id=None,
            комментарий=None
        )
        session.add(история1)
        session.commit()

        # Добавляем маршрут
        маршрут1 = Маршрут(
            отправление_id="TRK0001",
            отделение_откуда_id=1,
            отделение_куда_id=2,
            время_отправления=datetime.now(),
            время_прибытия=None
        )
        session.add(маршрут1)
        session.commit()

        # Добавляем заявку/тикет
        заявка1 = Заявка(
            клиент_id=1,
            отправление_id="TRK0001",
            время_создания=datetime.now(),
            тип="вопрос",
            описание="Уточнение доставки",
            результат=None
        )
        session.add(заявка1)
        session.commit()

if __name__ == "__main__":
    create_and_populate()
    print("База данных создана и минимальные данные добавлены.")
